#!/bin/sh

/bin/mount -n -t proc proc /proc
/bin/mount -n -t devpts devpts /dev/pts
export INSMOD="/sbin/insmod"
export RMMOD="/sbin/rmmod"
export MODDIR="/lib/modules/"$(uname -r)
export LD_LIBRARY_PATH=/tmp:/var/lib:/lib:$LD_LIBRARY_PATH
export PATH=/tmp:/var/bin:$PATH
#export TZ=CET-1CEST,M3.5.0/2,M10.5.0/3
/etc/init.d/init1

#set environment variables ( mID )
. /proc/bus/dbox.sh

mount -t ramfs none /tmp

# check if need flasherase 
/bin/mount -t jffs2 /dev/mtdblock/1 /var
if [ ! -e /var/.nemesis ] ; then
	touch /.noerase
	if [ ! -e /.noerase ] ; then
		umount /var
		/bin/eraseall /dev/mtd/1
		/bin/mount -t jffs2 /dev/mtdblock/1 /var
		touch /var/.nemesis
	fi
fi

/bin/showlogo /root/platform/kernel/bild

init=0

if [ ! -e /var/.init ]; then
    if [ -e /var/tmp/init ]; then
	touch /var/.init
	rm -rf /var/tmp
	ln -sf /tmp /var/tmp
    else
	init=1
    fi
fi

if [ $init -eq 1 ] ; then 
	cp -a /var_init/* /var
	touch /var/.init
	sync
	umount /var
	/bin/mount -t jffs2 /dev/mtdblock/1 /var
fi

mkdir /dev/ost
ln -s /dev/dvb/card0/demux0 /dev/ost/demux0
ln -sf ca0 /dev/ca1
ln -sf sound/dsp /dev/dsp
ln -sf fb/0 /dev/fb0
ln -s /dev/input/mice /dev/psaux 
ln -s /dev/input/mice /dev/mouse 

if [ ! -e /var/etc/hostname ] ; then
	cp /var_init/etc/hostname /var/etc/hostname
fi

if [ ! -e /var/tuxbox/config/encoding.conf ] ; then
	cp /var_init/tuxbox/config/enigma/enigma.conf /var/tuxbox/config/enigma
fi

/bin/hostname -F /var/etc/hostname

/sbin/ifconfig lo 127.0.0.1 netmask 255.0.0.0 up

/sbin/inetd &

if [ -r /var/etc/dropbear/dropbear_dss_host_key -a -r /var/etc/dropbear/dropbear_rsa_host_key ]; then
	/sbin/dropbear
fi

#change into folder in RAM ( ramfs )
cd /tmp

if [ ! -d /var/tuxbox/config/enigma/terrestrial ]; then
	mkdir /var/tuxbox/config/enigma/terrestrial
fi
if [ ! -d /var/tuxbox/config/enigma/cable ]; then
	mkdir /var/tuxbox/config/enigma/cable
fi

if [ -e /var/etc/install.tar ] ; then
	/bin/tar xvf /var/etc/install.tar -C /tmp
	/tmp/install
	rm /var/etc/install.tar
fi

if [ -e /var/etc/init ] ; then
	/var/etc/init
fi

# Nemesis-Project
[ -e /bin/enigmanet ] && /bin/enigmanet

[ -e /bin/nemesisd ] && /bin/nemesisd &

[ -e /var/script/mount.sh ] && /var/script/mount.sh

#Start tihrd-part at boot
list=`ls /var/etc/*_startup.sh`
for item in $list
	do
		${item} start
	done

#Start inadyn at boot
if [ -e /var/etc/inadynpar.conf ]; then
	[ ! -e /var/etc/.dont_start_inadyn ] && /var/script/inadyn_script.sh start
fi

#Start syslogd
if [ ! -e /var/etc/.dont_start_syslog ]; then
	export SYSLOG_PAR='-O /tmp/log/messsages'
	[ -e /var/etc/syslog.par ] && export SYSLOG_PAR=$(cat /var/etc/syslog.par)
	mkdir /tmp/log
	/sbin/syslogd ${SYSLOG_PAR}
	touch /tmp/.syslogstarted
fi

#Start Firewall
if [ ! -e /var/etc/.dont_start_firewall ]; then
	/var/script/firewall.sh start
	touch /tmp/.firewallstarted
fi

rm /var/etc/.dont_restart_enigma
touch /tmp/.enigma
while [ -e /tmp/.enigma ]
do
	if [ ! -e /var/etc/.dont_restart_enigma ] ; then
		/bin/enigma
		ret=$?
		echo "enigma returned with "$ret
		case $ret in
		0)
			echo "Shutdown"
			rm /tmp/.enigma
			/sbin/halt
			;;
		3)	    
			echo "Reboot Flash"
			rm /tmp/.enigma
			umount /var
			umount /hdd
			/bin/flashtool
			;;
		4)
			echo "Reboot"
			rm /tmp/.enigma
			/sbin/reboot
			;;
		*)	echo "Restart"
			;;
		esac
		killall -9 udhcpc
	else
		sleep 1
	fi
done

exit 0
